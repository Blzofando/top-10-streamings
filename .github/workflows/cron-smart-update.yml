name: Smart Update Cron

on:
  # TEMPORARIAMENTE COMENTADO - Usar cron-job.org em vez de GitHub Actions
  # schedule:
  #   # Executa a cada 5 minutos
  #   # Com 5 servi√ßos, atualiza todos em ~25 minutos
  #   # Reposit√≥rio P√öBLICO = execu√ß√µes ILIMITADAS e GRATUITAS! üéâ
  #   - cron: '*/5 * * * *'
  
  # Permite execu√ß√£o manual
  workflow_dispatch:

jobs:
  smart-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Smart Update - Verifica e Atualiza Dados Expirados
        run: |
          echo "üîÑ Iniciando verifica√ß√£o inteligente de dados expirados..."
          echo "üìÖ $(date)"
          
          # Chama endpoint inteligente que:
          # 1. Verifica timestamps no Firebase
          # 2. S√≥ atualiza se passou > 3 horas
          # 3. Processa sequencialmente
          response=$(curl -s -w "\n%{http_code}" \
            -X GET "https://top-10-streamings.onrender.com/api/cron/update-expired")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "üìä Status HTTP: $http_code"
          
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Cron job executado com sucesso!"
            echo ""
            echo "üìã Resumo:"
            echo "$body" | grep -o '"updated":\[[^]]*\]' || echo "Nenhum atualizado"
            echo "$body" | grep -o '"skipped":\[[^]]*\]' || echo "Todos expirados"
          else
            echo "‚ùå Erro no cron job"
            echo "Resposta: $body"
            exit 1
          fi
